use aiken/cbor
use cardano/address.{from_script}
use cocktail.{convert_int_to_bytes}
use mocktail.{mock_policy_id, mock_pub_key_hash, mock_script_hash}
use types.{CounterDatum, MemberDatum, OracleDatum, ProposalDatum}
use utils.{updated_member_datum}

pub const mock_first_admin = mock_pub_key_hash(0)

pub const mock_second_admin = mock_pub_key_hash(1)

pub const mock_third_admin = mock_pub_key_hash(2)

pub const mock_admins = [mock_first_admin, mock_second_admin, mock_third_admin]

pub const mock_admin_tenure = "11-11-1111"

pub const mock_multisig_threshold = 2

pub const mock_oracle_nft = mock_policy_id(0)

pub const mock_counter_nft = mock_policy_id(1)

pub const mock_membership_intent_token = mock_policy_id(2)

pub const mock_member_token = mock_policy_id(3)

pub const mock_propose_intent_token = mock_policy_id(4)

pub const mock_proposal_token = mock_policy_id(5)

pub const mock_sign_off_approval_token = mock_policy_id(6)

pub const mock_oracle_address = from_script("oracle_address")

pub const mock_counter_address = from_script("counter_address")

pub const mock_membership_intent_address =
  from_script("membership_intent_address")

pub const mock_member_address = from_script("member_address")

pub const mock_propose_intent_address = from_script("propose_intent_address")

pub const mock_proposal_address = from_script("proposal_address")

pub const mock_sign_off_approval_address =
  from_script("sign_off_approval_address")

pub const mock_treasury_address = from_script("treasury_address")

pub const mock_treasury_withdrawal_script_hash = mock_script_hash(700)

pub const mock_input_oracle_datum: OracleDatum =
  OracleDatum {
    admins: mock_admins,
    admin_tenure: mock_admin_tenure,
    multi_sig_threshold: mock_multisig_threshold,
    oracle_nft: mock_oracle_nft,
    oracle_address: mock_oracle_address,
    counter_nft: mock_counter_nft,
    counter_address: mock_counter_address,
    membership_intent_token: mock_membership_intent_token,
    memebership_intent_address: mock_membership_intent_address,
    member_token: mock_member_token,
    member_address: mock_member_address,
    propose_intent_token: mock_propose_intent_token,
    propose_intent_address: mock_propose_intent_address,
    proposal_token: mock_proposal_token,
    proposal_address: mock_proposal_address,
    sign_off_approval_token: mock_sign_off_approval_token,
    sign_off_approval_address: mock_sign_off_approval_address,
    treasury_address: mock_treasury_address,
    treasury_withdrawal_script_hash: mock_treasury_withdrawal_script_hash,
  }

pub const mock_new_first_admin = mock_pub_key_hash(10)

pub const mock_new_second_admin = mock_pub_key_hash(11)

pub const mock_new_third_admin = mock_pub_key_hash(12)

pub const mock_new_admins =
  [mock_new_first_admin, mock_new_second_admin, mock_new_third_admin]

pub const mock_new_multisig_threshold = 1

pub const mock_new_admin_tenure = "22-22-2222"

pub const mock_counter_input_datum = CounterDatum { count: 2 }

pub const mock_counter_count = "2"

pub const mock_user_token = (mock_policy_id(20), "user_token")

pub const mock_user_address = from_script("user_address")

pub const mock_metadata = "abc project"

pub const mock_fund_requested = 1000

pub const mock_member = 2

pub const mock_receiver = from_script("receiver")

pub const mock_member_datum =
  MemberDatum {
    token: (mock_user_token.1st, mock_user_token.2nd),
    completion: [],
    fund_recevied: 0,
    metadata: mock_metadata,
  }

pub const mock_proposal_datum =
  ProposalDatum {
    fund_requested: mock_fund_requested,
    receiver: mock_receiver,
    member: mock_member,
    metadata: mock_metadata,
  }

test gg() {
  let a = 0
  let b = convert_int_to_bytes(a)

  (b == "30")?
}

test test_datum_p() {
  let data =
    #"d8799f1a01036640d8799fd8799f581cd1fe58f4f848d113ae870eb5518951e4a7f441beb0b83462eb2bc3dcffd8799fd8799fd8799f581c8a5a7827587d2944b6fd4cde214f9b063a6ae262a13e9ab4690b24c0ffffffff02d8799f515375626d697420612070726f706f73616c9f582068747470733a2f2f6769746875622e636f6d2f456d6d616e75656c2d5479747958202f63727973656e742f626c6f622f756e646566696e65642f70726f706f73616c5820732d6170706c69636174696f6e732f636f6e74656e742f7375626d69742d612d582070726f706f73616c2d616464725f74657374317172676c756b38356c7079647a5820796177737538743235766632386a3230617a70683663747364727a617634753858206879327466757a776b726139397a74646c32766d6373356c786378386634777958186334703836647467366774796e71716b67687578752e6d64ff483137303030303030d8799fd8799f581cd1fe58f4f848d113ae870eb5518951e4a7f441beb0b83462eb2bc3dcffd8799fd8799fd8799f581c8a5a7827587d2944b6fd4cde214f9b063a6ae262a13e9ab4690b24c0ffffffffd8799fd8799f581cd1fe58f4f848d113ae870eb5518951e4a7f441beb0b83462eb2bc3dcffd8799fd8799fd8799f581c8a5a7827587d2944b6fd4cde214f9b063a6ae262a13e9ab4690b24c0ffffffff4770656e64696e67ffff"

  expect Some(proposal) = cbor.deserialise(data)
  expect p: ProposalDatum = proposal
  p.fund_requested == 17000000
}

test test_datum_m() {
  let data =
    #"d8799f9f581cc76c35088ac826c8a0e6947c8ff78d8d4495789bc729419b3a3343054b3232326667647373535353ffa000d8799fd8799fd8799f581cab44f916e940ef5233582b9e901359c806374a644b2a5a404171d589ffd8799fd8799fd8799f581c8dabad4a2faaa2c13312f16f0feb3af58b47025b717ac059f555648bffffffff4d57796e7465722047726168616d54526174696f6e652076656c6974207175697320715672697a656b7572406d61696c696e61746f722e636f6d53457374206572726f7220736564206561206578424b45474d6f6d62617361ffff"

  expect Some(member) = cbor.deserialise(data)
  expect m: MemberDatum = member
  m.completion == []
}

test test_datum_o() {
  let data =
    #"d8799f9f581c62bf3aaffe8fa1f9234eebbf929fadc1578953512d0702f3a4c75fd3581ceefc003a4f060ed3248086618042734b2af45239a565fc4d66aaa865581cf9de2526ed608b49c9c4e1d8e53cd21cb0606f4f902d78a91043ddddff42317901581c18335b8db6b15a90c8381afd20a415f7b335e8c195f105dfac9f2b6fd8799fd87a9f581c56ec5d32ef43cb7051b2b7d9425cd471435d511b140c58582c5f1f79ffd87a80ff581c67142350ec10d010ab2ae17d45e15825856586089f82e61c2417a61cd8799fd87a9f581cb86fa66f980afa0c71b9b4e7ff40e98d11d85f56eec9f11bead9605dffd87a80ff581c02e7ab63d0c8de8b79f3148e5913ecb531cd900068ce188f68219056d8799fd87a9f581c7d3fe580affc19cbb8061ebacdf50ebcc3b17b60b4335ce855bd58f9ffd87a80ff581cd13c75c6fdd6480ec1d0b1dcb41a634fb2d236a7074dcebb7f9f200dd8799fd87a9f581c04d6c98e05606e4ea7588e924d7925a6a4e4e768e06115801506a13effd87a80ff581ca8ba36f20bfb4594c30907028b1b3990389627b9cdbe123041482ce5d8799fd87a9f581cda815a86d8f70d38ad18b1b10442f8c249929563899a9a5086661eeeffd87a80ff581c96ee753a0cd43974d6f429ce1219fabe3f1f81a4717ed1d2e57a8f4ad8799fd87a9f581c0505c9dd1d4628540781dfcf13bbc231454c59b92ecf1b5b24f7966affd87a80ff581c40e0d0bbb8241e161f1023647c21b49d40ecee845b794e19a417456ed8799fd87a9f581cd33a78cd22a38a1b32caeed6197236c1905e2b7d3fe1c29b18ecc845ffd87a80ffd8799fd87a9f581ca92cee38c88df651f0a5d7e04cefc3cddb5b9e16db4370876848a47bffd87a80ff581c1e8a03e80431773ffba59f8f517da4b4253da11ded8aacd496ce2e2fff"

  expect Some(oracle) = cbor.deserialise(data)
  expect o: OracleDatum = oracle
  o.treasury_withdrawal_script_hash == #"1e8a03e80431773ffba59f8f517da4b4253da11ded8aacd496ce2e2f"
}

test test_datum_m_output() {
  let data =
    #"d8799f9f581cc76c35088ac826c8a0e6947c8ff78d8d4495789bc729419b3a3343054b3232326667647373535353ffa1d8799f515375626d697420612070726f706f73616c9f582036383734373437303733336132663266363736393734363837353632326536335820366636643266343536643664363136653735363536633264353437393734373958203266363337323739373336353665373432663632366336663632326637353665582036343635363636393665363536343266373037323666373036663733363136635820373332643631373037303663363936333631373436393666366537333266363358203666366537343635366537343266373337353632366436393734326436313264582037303732366637303666373336313663326436313634363437323566373436355820373337343331373137323637366337353662333833353663373037393634376158203739363137373733373533383734333233353736363633323338366133323330582036313761373036383336363337343733363437323761363137363334373533385820363837393332373436363735376137373662373236313339333937613734363458203663333237363664363337333335366337383633373833383636333437373739582036333334373033383336363437343637333636373734373936653731373136625036373638373537383735326536643634ff483137303030303030d8799fd8799f581cd1fe58f4f848d113ae870eb5518951e4a7f441beb0b83462eb2bc3dcffd8799fd8799fd8799f581c8a5a7827587d2944b6fd4cde214f9b063a6ae262a13e9ab4690b24c0ffffffffd8799fd8799f581cd1fe58f4f848d113ae870eb5518951e4a7f441beb0b83462eb2bc3dcffd8799fd8799fd8799f581c8a5a7827587d2944b6fd4cde214f9b063a6ae262a13e9ab4690b24c0ffffffff4770656e64696e67ff1a010366401a01036640d8799fd8799fd8799f581cab44f916e940ef5233582b9e901359c806374a644b2a5a404171d589ffd8799fd8799fd8799f581c8dabad4a2faaa2c13312f16f0feb3af58b47025b717ac059f555648bffffffff4d57796e7465722047726168616d54526174696f6e652076656c6974207175697320715672697a656b7572406d61696c696e61746f722e636f6d53457374206572726f7220736564206561206578424b45474d6f6d626173614040404040ffff"

  expect Some(member) = cbor.deserialise(data)
  expect m: MemberDatum = member
  m.completion != []
}

test test_datum_m_output_updated() {
  let data_m_in =
    #"d8799f9f581cc76c35088ac826c8a0e6947c8ff78d8d4495789bc729419b3a3343054b3232326667647373535353ffa000d8799fd8799fd8799f581cab44f916e940ef5233582b9e901359c806374a644b2a5a404171d589ffd8799fd8799fd8799f581c8dabad4a2faaa2c13312f16f0feb3af58b47025b717ac059f555648bffffffff4d57796e7465722047726168616d54526174696f6e652076656c6974207175697320715672697a656b7572406d61696c696e61746f722e636f6d53457374206572726f7220736564206561206578424b45474d6f6d62617361ffff"
  expect Some(member_in) = cbor.deserialise(data_m_in)
  expect m_in: MemberDatum = member_in

  let data_m_out =
    #"d8799f9f581cc76c35088ac826c8a0e6947c8ff78d8d4495789bc729419b3a3343054b3232326667647373535353ffa1d8799f515375626d697420612070726f706f73616c9f582068747470733a2f2f6769746875622e636f6d2f456d6d616e75656c2d5479747958202f63727973656e742f626c6f622f756e646566696e65642f70726f706f73616c5820732d6170706c69636174696f6e732f636f6e74656e742f7375626d69742d612d582070726f706f73616c2d616464725f74657374317172676c756b38356c7079647a5820796177737538743235766632386a3230617a70683663747364727a617634753858206879327466757a776b726139397a74646c32766d6373356c786378386634777958186334703836647467366774796e71716b67687578752e6d64ff483137303030303030d8799fd8799f581cd1fe58f4f848d113ae870eb5518951e4a7f441beb0b83462eb2bc3dcffd8799fd8799fd8799f581c8a5a7827587d2944b6fd4cde214f9b063a6ae262a13e9ab4690b24c0ffffffffd8799fd8799f581cd1fe58f4f848d113ae870eb5518951e4a7f441beb0b83462eb2bc3dcffd8799fd8799fd8799f581c8a5a7827587d2944b6fd4cde214f9b063a6ae262a13e9ab4690b24c0ffffffff4770656e64696e67ff1a010366401a01036640d8799fd8799fd8799f581cab44f916e940ef5233582b9e901359c806374a644b2a5a404171d589ffd8799fd8799fd8799f581c8dabad4a2faaa2c13312f16f0feb3af58b47025b717ac059f555648bffffffff4d57796e7465722047726168616d54526174696f6e652076656c6974207175697320715672697a656b7572406d61696c696e61746f722e636f6d53457374206572726f7220736564206561206578424b45474d6f6d626173614040404040ffff"

  expect Some(member_out) = cbor.deserialise(data_m_out)
  expect m_out: MemberDatum = member_out

  let data_p =
    #"d8799f1a01036640d8799fd8799f581cd1fe58f4f848d113ae870eb5518951e4a7f441beb0b83462eb2bc3dcffd8799fd8799fd8799f581c8a5a7827587d2944b6fd4cde214f9b063a6ae262a13e9ab4690b24c0ffffffff02d8799f515375626d697420612070726f706f73616c9f582068747470733a2f2f6769746875622e636f6d2f456d6d616e75656c2d5479747958202f63727973656e742f626c6f622f756e646566696e65642f70726f706f73616c5820732d6170706c69636174696f6e732f636f6e74656e742f7375626d69742d612d582070726f706f73616c2d616464725f74657374317172676c756b38356c7079647a5820796177737538743235766632386a3230617a70683663747364727a617634753858206879327466757a776b726139397a74646c32766d6373356c786378386634777958186334703836647467366774796e71716b67687578752e6d64ff483137303030303030d8799fd8799f581cd1fe58f4f848d113ae870eb5518951e4a7f441beb0b83462eb2bc3dcffd8799fd8799fd8799f581c8a5a7827587d2944b6fd4cde214f9b063a6ae262a13e9ab4690b24c0ffffffffd8799fd8799f581cd1fe58f4f848d113ae870eb5518951e4a7f441beb0b83462eb2bc3dcffd8799fd8799fd8799f581c8a5a7827587d2944b6fd4cde214f9b063a6ae262a13e9ab4690b24c0ffffffff4770656e64696e67ffff"
  expect Some(proposal) = cbor.deserialise(data_p)
  expect p: ProposalDatum = proposal

  let expected_m_out = updated_member_datum(m_in, p)

  (expected_m_out == m_out)?
}
